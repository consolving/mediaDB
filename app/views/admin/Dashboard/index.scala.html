@import services.JobService
@import helpers.MediaFileHelper
@import views.addons._
@import models.Thumbnail

@(mediaFileCount: Integer, thumbnailsCount:Integer, tagCount: Integer, propertyCount: Integer)

@scripts = {
    <script type="text/javascript">

		var color = d3.scale.category20c();			
		var width = 500,
		    height = 250,
			radius = Math.min(width, height) / 3;
		
		var pie = d3.layout.pie()
			.sort(null)
			.value(function(d) {
				return d.value;
			});
		
		var arc = d3.svg.arc()
			.outerRadius(radius * 0.8)
			.innerRadius(radius * 0.4);
		
		var outerArc = d3.svg.arc()
			.innerRadius(radius * 0.9)
			.outerRadius(radius * 0.9);
		
		
		var key = function(d){ return d.data.label; };
		
	 	var alpha = 0.5;
    	var spacing = 16;		

		function draw(data, graphId) {

	    	var svg = d3.select(graphId)
					.append("svg")
					.append("g");
				 svg.append("g")
					.attr("class", "slices");
				 svg.append("g")
					.attr("class", "labels");
				 svg.append("g")
					.attr("class", "lines");		
			var labelPositions = {};

			svg.attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");
			console.log(JSON.stringify(data));
			/* ------- PIE SLICES -------*/
			var slice = svg.select(".slices").selectAll("path.slice").data(pie(data), key);
		
			slice.enter()
				.insert("path")
				.style("fill", function(d) { return color(d.data.label); })
				.attr("class", "slice");
		
			slice		
				.transition().duration(1000)
				.attrTween("d", function(d) {
					this._current = this._current || d;
					var interpolate = d3.interpolate(this._current, d);
					this._current = interpolate(0);
					return function(t) {
						return arc(interpolate(t));
					};
				})
		
			slice.exit()
				.remove();
		
			/* ------- TEXT LABELS -------*/
		
			var textId = 1;
			var text = svg.select(".labels").selectAll("text").data(pie(data), key);	
				text.enter()
					.append("text")
					.attr("dy", ".35em")
					.attr("id", function(d){
						return "text-"+textId++;
					})
					.text(function(d) {
						return d.data.label;
					});
				
			function midAngle(d){
				return d.startAngle + (d.endAngle - d.startAngle)/2;
			}
		
			text.transition().duration(1000)
				.attrTween("transform", function(d) {
					this._current = this._current || d;
					var interpolate = d3.interpolate(this._current, d);
					this._current = interpolate(0);
					return function(t) {
						var d2 = interpolate(t);
						var pos = outerArc.centroid(d2);
						pos[0] = radius * (midAngle(d2) < Math.PI ? 1 : -1);
						return "translate("+ pos +")";
					};
				}).each("end",function(){
					relax(graphId);
				})
				.styleTween("text-anchor", function(d){
					this._current = this._current || d;
					var interpolate = d3.interpolate(this._current, d);
					this._current = interpolate(0);
					return function(t) {
						var d2 = interpolate(t);
						return midAngle(d2) < Math.PI ? "start":"end";
					};
				});
			text.exit()
				.remove();

			/* ------- SLICE TO TEXT POLYLINES -------*/
		
			var polyline = svg.select(".lines").selectAll("polyline").data(pie(data), key);
				polyline.enter()
						.append("polyline");
		
				polyline.transition().duration(1000)
						.attrTween("points", function(d){
							this._current = this._current || d;
							var interpolate = d3.interpolate(this._current, d);
							this._current = interpolate(0);
							return function(t) {
								var d2 = interpolate(t);
								var pos = outerArc.centroid(d2);
								pos[0] = radius * 0.95 * (midAngle(d2) < Math.PI ? 1 : -1);
								return [arc.centroid(d2), outerArc.centroid(d2), pos];
							};			
						});
			
				polyline.exit()
						.remove();
		};

		function relax(graphId) {
			var svg = d3.select(graphId);
			var text = svg.select(".labels").selectAll("text");
			again = false;
			text.each(function (d, i) {
		    	a = this;
		    	da = d3.select(a);
		    	y1 = da.attr("y");
		    	text.each(function (d, j) {
			        b = this;
			        // a & b are the same element and don't collide.
			        if (a.id == b.id) return;
			        db = d3.select(b);
			        // a & b are on opposite sides of the chart and
			        // don't collide
			        if (da.attr("text-anchor") != db.attr("text-anchor")) return;
			        // Now let's calculate the distance between
			        // these elements. 
			        y2 = db.attr("y");
			        deltaY = y1 - y2;

			        // If spacing is greater than our specified spacing,
			        // they don't collide.
			        if (Math.abs(deltaY) > spacing) return;

			        // If the labels collide, we'll push each 
			        // of the two labels up and down a little bit.
			        again = true;
			        sign = deltaY > 0 ? 1 : -1;
			        adjust = sign * alpha;
			        da.attr("y",+y1 + adjust);
			        db.attr("y",+y2 - adjust);   
			    });

			});

			if(again) {
		    	setTimeout(function(){relax(graphId)},20)
			};
		};	

		$.get('@routes.MediaFiles.folderStats()', function( data ) {
			draw(data.dirsSizes, '#folder-sizes');
			draw(data.dirsCounts, '#folder-counts');
		});								
    </script>
}

@main("Welcome to media DB", scripts) {
    <div class="row center">
    	<h2>Administration Dashboard</h2>
    </div>
	<div class="row">
		<div class="col-md-6 center">
			<h2>File Size</h2>
			<div class="front-graph" id="folder-sizes"></div>
		</div>
		<div class="col-md-6 center">
			<h2>File Counts</h2>
			<div class="front-graph" id="folder-counts"></div>
		</div>		
	</div>
    <div class="row"> 
		<div class="col-md-3 center">
			<h2>
				<small>Media Files</small><br />
				@mediaFileCount
			</h2>
		</div>
		<div class="col-md-3 center">
			<h2>
				<small>Thumbnails</small><br />
				@thumbnailsCount		
			</h2>
		</div>
		<div class="col-md-3 center">
			<h2>
				<small>Tags</small><br />
				@tagCount		
			</h2>
		</div>
		<div class="col-md-3 center">
			<h2>
				<small>Properties</small><br />
				@propertyCount
			</h2>
		</div>			
	</div>	
	<div class="row"> 
		<div class="col-md-12 center">
			<h2>Jobs</h2>
			<table class="table table-condensed">
				<tr>
					<th>Name</th>	
					<th>Status</th>
					<th>Runs every</th>
					<th>last Run</th>
					<th>next Run</th>			
					<th></th>
				</tr>
			@for(job <- JobService.getJobNames()) {
				<tr>
					<td>@job</td>
					<td>@JobService.getStatus(job)</td>
					<td>@JobService.getJob(job).getRunEvery() minutes</td>
					<td>@JobService.getLastRun(job).since()</td>
					<td>@JobService.getNextRun(job).since()</td>
					<td>
                	@if(JobService.isCancellable(job)) {
                		<form action="@routes.Jobs.toggleJobActive(job)" method="POST"><button class="btn @if(JobService.isJobActive(job)){btn-danger">disable}else{btn-success">enable}</button></form>
                	}
                    </td>					
				</tr>
			}
			</table>
		</div>   				
    </div>
}
